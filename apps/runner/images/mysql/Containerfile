ARG RUNNER_IMAGE=ghcr.io/hexlet-codebattle/runner-zig:latest
ARG MYSQL_TAG=8.4.7
ARG TARGETPLATFORM

FROM --platform=$TARGETPLATFORM ${RUNNER_IMAGE} AS runner
FROM --platform=$TARGETPLATFORM mysql:${MYSQL_TAG}

# mysql official (Oracle Linux) uses microdnf
RUN microdnf install -y make && microdnf clean all

ENV MYSQL_DATABASE=db \
  MYSQL_USER=user \
  MYSQL_PASSWORD=password \
  MYSQL_ROOT_PASSWORD=rootpassword

WORKDIR /usr/src/app

EXPOSE 4040

COPY single_table.sql .
COPY Makefile .

# keep MySQL's entrypoint
COPY --from=runner /app/codebattle_runner /runner/codebattle_runner
CMD ["mysqld"]
