# Stage 1: Codebattle runner binary
ARG RUNNER_IMAGE=ghcr.io/hexlet-codebattle/runner-rs:latest
ARG TARGETPLATFORM
FROM --platform=$TARGETPLATFORM ${RUNNER_IMAGE} AS runner

# Stage 2: Haskell environment
FROM --platform=$TARGETPLATFORM haskell:9.12.2-slim-bookworm

WORKDIR /usr/src/app

RUN apt-get update && \
  apt-get install -y --no-install-recommends make cabal-install curl ca-certificates && \
  rm -rf /var/lib/apt/lists/*

# Add project files
ADD cabal.project .
ADD checker.cabal .
ADD LICENSE .

# Update cabal package index
RUN cabal update

# Pre-fetch dependencies (serial + no optimization to avoid OOM)
RUN cabal build --only-dependencies -j1 --ghc-options="-O0" || true

# Add source and makefile
ADD check check
ADD Makefile .

EXPOSE 8000

# Copy Codebattle runner binary
COPY --from=runner /app/codebattle_runner /runner/codebattle_runner

ENTRYPOINT ["/runner/codebattle_runner"]
