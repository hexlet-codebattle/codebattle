defmodule CodebattleWeb.Api.V1.GameActivityController do
  use CodebattleWeb, :controller

  import Ecto.Query, only: [from: 2]

  alias Codebattle.Game
  alias Codebattle.Repo

  defmacro to_char(field, format) do
    quote do
      fragment("to_char(?, ?)", unquote(field), unquote(format))
    end
  end

  def show(conn, %{}) do
    query =
      from(g in Game,
        group_by: to_char(g.inserted_at, "YYYY-mm-dd"),
        select: %{date: to_char(g.inserted_at, "YYYY-mm-dd"), count: count(g.id)}
      )

    activities = Repo.all(query)
    json(conn, %{activities: activities})
  end
end
